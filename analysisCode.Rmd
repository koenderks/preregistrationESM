---
title: "Preregistration ESM analysis code"
author: "Anu Hiekkaranta & Koen Derks"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 5
    number_sections: true
    df_print: paged
---

```{r document options, echo = F}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center", fig.width = 10)
```

```{r setup}

# Clear workspace
rm(list=ls())

## Load required packages

library(lme4)		        # For frequentist hierarchical modeling
library(lmerTest)	      # For testing effect in lme4
library(brms) 	        # For Bayesian hierarchical modeling
library(bayesplot)	    # For plotting the samples
library(RColorBrewer)   # needed for some extra colours in one of the graphs
library(ggmcmc)
library(ggthemes)
library(ggridges)
library(gridExtra)

## Specify the options for `lme4`

ctrl <- lme4::lmerControl(optimizer = "optimx", calc.derivs = FALSE,
                     optCtrl = list(method = "nlminb", starttests = FALSE, 
                                         kkt = FALSE))

## Specify the options for `brms`
warmup      <- 1000
iterations  <- 5000
chains      <- 4
cores       <- 4

## Set global seed to reproduce results
seed        <- 120495

# Helper functions
.plotCaterpillars <- function(mtfit, parameters, warmup = 1000){
  p <- ggplot(filter(mtfit, Parameter %in% parameters),
        aes(x   = Iteration, y   = value, col = as.factor(Chain)))+
        geom_line() +
        geom_vline(xintercept = warmup)+
        facet_grid(Parameter ~ . , scale  = 'free_y', switch = 'y')+
        labs(title = "Caterpillar Plots", col = "Chains")
  return(p)
}

```

# Data

```{r data}

# Rad data set
dataset <- read.csv(file = "https://raw.githubusercontent.com/koenderks/preregistrationESM/master/CCP_pilot_resampled.csv", sep = ",")

dataset$ID <- as.factor(dataset$ID)
dataset$DAY <- as.factor(dataset$DAY)

# Inspect the data set
head(dataset)
```

# Analyses

```{r, echo = FALSE}
set.seed(seed)
```

## Model 1: Sharing negative events

```{r class.source = "fold-show"}
# Hypothesis 1: 
# Talking more about daily negative events is associated with lower psychopathology 
# -> Negative population effect (PP < 0).
#
# Hypothesis 6: 
# Intensity of daily negative events is positively associated with sharing 
# -> Positive group effect (INEG|ID > 0).
# 
# Model:
# SHAREN ~ PP + AGE + GEN + INEG|ID/DAY

model1 <- SHAREN ~ 1 + PP + AGE + GEN + INEG|ID/DAY
```

### Frequentist analysis

```{r class.source = "fold-show"}
fit1_f  <- lme4::lmer(formula = model1, data = dataset, control = ctrl)
sum1_f  <- summary(fit1_f)
test1_f <- lmerTest::ranova(fit1_f)

print(test1_f)
```

### Bayesian analysis

#### Default priors

##### Extract default prior distributions

```{r class.source = "fold-show"}
model1 <- SHAREN ~ 1 + PP + AGE + GEN + (1 + INEG|ID/DAY)
priors_1_default <- brms::get_prior(formula = model1, data = dataset)
```

##### Fit model using default priors

```{r class.source = "fold-show"}
fit1_b <- brms::brm(formula = model1, 
                    data = dataset, 
                    inits = "random",
                    chains = chains,
                    cores = cores, 
                    prior = NULL,       # NULL for default priors
                    warmup = warmup, 
                    iter = iterations,
                    seed = seed,
                    sample_prior = "yes",
                    control = list(adapt_delta = 0.999),
                    save_pars = brms::save_pars(all = TRUE))
```

##### Inspect convergence of the chains

```{r}
mt1 <- ggs(fit1_b)
parameters_to_plot <- c("b_PP", "sd_ID__INEG")

.plotCaterpillars(mt1, parameters = parameters_to_plot, warmup = 100)
```

##### Inspect parameter estimates

```{r class.source = "fold-show"}
summary(fit1_b, priors = TRUE)
```

##### Hypothesis 1: PP < 0

```{r class.source = "fold-show"}
hypothesis1_b <- brms::hypothesis(fit1_b, "PP < 0", class = "b")
print(hypothesis1_b)
```


```{r}
parameter <- "b_PP"
p1 <- plot(hypothesis1_b, plot = F)[[1]]
p2 <- ggplot(filter(mt1, Parameter == parameter, Iteration > 100), aes(x = value))+
      geom_density(fill  = "yellow", alpha = .5)+
      geom_vline(xintercept = 0, col  = "red", size = 1)+
      scale_x_continuous(name   = "Value", limits = c(-200, 200)) + 
      geom_vline(xintercept = summary(fit1_b)$fixed[2,3:4], col = "blue", linetype = 2) +
      theme_light() +
      labs(title = paste0("Posterior Density of ", parameter))
grid.arrange(p1, p2, nrow = 1)
```

##### Hypothesis 6: INEG|ID > 0

```{r, collapse = FALSE}
hypothesis6_b <- brms::hypothesis(fit1_b, "INEG > 0", class = "sd", group = "ID")
print(hypothesis6_b)
```


```{r, collapse = FALSE}
parameter <- "sd_ID__INEG"
p1 <- plot(hypothesis6_b, plot = F)[[1]]
p2 <- ggplot(filter(mt1, Parameter == parameter, Iteration > 100), aes(x = value))+
      geom_density(fill  = "yellow", alpha = .5)+
      geom_vline(xintercept = 0, col  = "red", size = 1)+
      scale_x_continuous(name   = "Value", limits = c(-10, 10)) + 
      geom_vline(xintercept = summary(fit1_b)$random$ID[2,3:4], col = "blue", linetype = 2) +
      theme_light() +
      labs(title = paste0("Posterior Density of ", parameter))
grid.arrange(p1, p2, nrow = 1)
```

#### Informed priors

##### Specify informed prior distributions

```{r class.source = "fold-show"}
#
# Priors:
# b_Intercept ~ Cauchy(-0.48, 0.85)
# b_Age ~ Normal(-0.01, 0.05)
# b_PP ~ Normal(-.26,.25)
# b_GEN ~ Normal(0.45,.12)
# sd_INEG_ID ~ Normal(0.48,.06)

priors1 <- set_prior("cauchy(-.48,.85)", class = "b")
priors1 <- c(priors1, set_prior("normal(-.01, .05)", class = "b", coef= "AGE"))
priors1 <- c(priors1, set_prior("normal(-.26,.25)",  class = "b", coef= "PP"))
priors1 <- c(priors1, set_prior("normal(0.45,.12)",  class = "b", coef= "GEN"))
priors1 <- c(priors1, set_prior("normal(0.48,.06)",   class = "sd", coef= "INEG", group = "ID"))
```

##### Fit model using informed priors

```{r class.source = "fold-show"}
fit1_bi <- brms::brm(formula = model1, 
                    data = dataset, 
                    inits = "random",
                    chains = chains,
                    cores = cores, 
                    prior = NULL,                  # NULL for default priors, priors1 for custom
                    warmup = warmup, 
                    iter = iterations,
                    seed = seed,
                    sample_prior = "yes",
                    control = list(adapt_delta = 0.999),
                    save_pars = brms::save_pars(all = TRUE))
```

##### Inspect convergence of the chains

```{r}
mt1i <- ggs(fit1_bi)
parameters_to_plot <- c("b_PP", "sd_ID__INEG")

.plotCaterpillars(mt1i, parameters = parameters_to_plot, warmup = 100)
```

##### Inspect parameter estimates

```{r class.source = "fold-show"}
summary(fit1_bi, priors = TRUE)
```

##### Hypothesis 1: PP < 0

```{r class.source = "fold-show"}
hypothesis1_bi <- brms::hypothesis(fit1_bi, "PP < 0", class = "b")
print(hypothesis1_bi)
```


```{r}
parameter <- "b_PP"
p1 <- plot(hypothesis1_bi, plot = F)[[1]]
p2 <- ggplot(filter(mt1i, Parameter == parameter, Iteration > 100), aes(x = value))+
      geom_density(fill  = "yellow", alpha = .5)+
      geom_vline(xintercept = 0, col  = "red", size = 1)+
      scale_x_continuous(name   = "Value", limits = c(-200, 200)) + 
      geom_vline(xintercept = summary(fit1_bi)$fixed[2,3:4], col = "blue", linetype = 2) +
      theme_light() +
      labs(title = paste0("Posterior Density of ", parameter))
grid.arrange(p1, p2, nrow = 1)
```

##### Hypothesis 6: INEG|ID > 0

```{r, collapse = FALSE}
hypothesis6_bi <- brms::hypothesis(fit1_bi, "INEG > 0", class = "sd", group = "ID")
print(hypothesis6_bi)
```


```{r, collapse = FALSE}
parameter <- "sd_ID__INEG"
p1 <- plot(hypothesis6_bi, plot = F)[[1]]
p2 <- ggplot(filter(mt1i, Parameter == parameter, Iteration > 100), aes(x = value))+
      geom_density(fill  = "yellow", alpha = .5)+
      geom_vline(xintercept = 0, col  = "red", size = 1)+
      scale_x_continuous(name   = "Value", limits = c(-10, 10)) + 
      geom_vline(xintercept = summary(fit1_bi)$random$ID[2,3:4], col = "blue", linetype = 2) +
      theme_light() +
      labs(title = paste0("Posterior Density of ", parameter))
grid.arrange(p1, p2, nrow = 1)
```

#### Influence of priors

## Model 2: Sharing positive events

```{r specify model 2}
# Hypothesis 3: Talking more about daily positive events is not associated with psychopathology -> No population effect (PP = 0).
# Hypothesis 8: Intensity of daily positive events is positively associated with sharing -> Positive group effect (IPOS/ID > 0).

model2 <- SHAREN ~ PP + AGE + GEN + IPOS|ID/DAY
```

### Frequentist analysis

```{r fit model 2}
# fit2_f <- lme4::lmer(formula = model2, data = dataset, control = ctrl)
# sum2_f <- summary(fit2_f)
# test2_f <- lmerTest::ranova(fit2_f)
```

## Model 3: Ruminating negative events

```{r specify model 3}
# Hypothesis 2: Ruminating more about daily negative events is associated with higher psychopathology -> Positive population effect (PP > 0).
# Hypothesis 5: Intensity of daily negative events is positively associated with rumination. -> Positive group effect (INEG/DAY > 0).

model3 <- RUM ~ PP + AGE + GEN + INEG|ID/DAY
```

### Frequentist analysis

```{r fit model 3}
fit3_f <- lme4::lmer(formula = model3, data = dataset, control = ctrl)
sum3_f <- summary(fit3_f)
test3_f <- lmerTest::ranova(fit3_f)
```

## Model 4: Savouring positive events

```{r specify model 4}
# Hypothesis 4: Savouring daily positive events is not associated with psychopathology. -> No population effect (PP = 0)
# Hypothesis 7: Intensity of daily positive events is positively associated with savouring. -> Positive group effect (IPOS/DAY > 0)

model4 <- SAV ~ PP + AGE + GEN + IPOS|ID/DAY
```

### Frequentist analysis

```{r fit model 4}
fit4_f <- lme4::lmer(formula = model4, data = dataset, control = ctrl)
sum4_f <- summary(fit4_f)
test4_f <- lmerTest::ranova(fit4_f)
```

## Model 5: Intensity negative events

```{r specify model 5}
# Hypothesis 9: Psychopathology is positively associated with the intensity of daily negative events. -> Positive population effect (PP > 0).

model5 <- INEG ~ PP + AGE + GEN
```

### Frequentist analysis

```{r fit model 5}
# fit5_f <- lme4::lmer(formula = model5, data = dataset, control = ctrl)
# sum5_f <- summary(fit5_f)
# test5_f <- lmerTest::ranova(fit5_f)
```

## Model 6: Intensity positive events

```{r specify model 6}
# Hypothesis 10: Psychopathology is not associated with the intensity of daily positive events. -> No population effect (PP = 0).

model6 <- IPOS ~ PP + AGE + GEN
```

### Frequentist analysis

```{r fit model 6}
# fit6_f <- lme4::lmer(formula = model6, data = dataset, control = ctrl)
# sum6_f <- summary(fit6_f)
# test6_f <- lmerTest::ranova(fit6_f)
```

# Results

```{r, collapse = FALSE}
results <- data.frame(Hypothesis = 1:10, 
                      Model = c(1, NA, NA, NA, NA, 1, NA, NA, NA, NA), 
                      Restriction = numeric(10), 
                      pval = numeric(10), 
                      er = numeric(10)) 
results$Restriction[c(1, 6)] <- c("PP = 0", 
                                  "INEG > 0")
results$pval[c(1, 6)] <- c(test1_f$`Pr(>Chisq)`[6],
                           test1_f$`Pr(>Chisq)`[9])
results$er[c(1, 6)] <- c(hypothesis1_b$hypothesis[6], 
                          hypothesis6_b$hypothesis[6])
print(results)
```
